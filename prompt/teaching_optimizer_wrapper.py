#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ•™å­¦ä¼˜åŒ–å™¨åŒ…è£…å™¨
ä¸ºç¼–ç¨‹æ•™å­¦ä»»åŠ¡å®šåˆ¶åˆå§‹åŒ–é€»è¾‘
"""

import sys
import os

# æ·»åŠ è·¯å¾„
parent_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, os.path.join(parent_dir, 'EvoAutoprompt'))
sys.path.insert(0, parent_dir)

from evo_phase_optimizer import EvoPhasePromptOptimizer, PromptCandidate

class TeachingOptimizer(EvoPhasePromptOptimizer):
    """
    ä¸“é—¨ä¸ºç¼–ç¨‹æ•™å­¦ä»»åŠ¡å®šåˆ¶çš„ä¼˜åŒ–å™¨
    è¦†ç›–åˆå§‹ç§ç¾¤ç”Ÿæˆé€»è¾‘å’Œå˜å¼‚ç®—å­
    """
    
    def feedback_mutation(self, parent):
        """åé¦ˆå˜å¼‚ - åŸºäºä½åˆ†æ ·æœ¬æ”¹è¿›ï¼ˆæ•™å­¦ä»»åŠ¡ä¸“ç”¨ï¼‰"""
        # è·å–ä½åˆ†æ ·æœ¬
        if not hasattr(self, 'fp_pool') or not self.fp_pool.samples:
            return parent
            
        error_samples = self.fp_pool.sample(k=3, strategy="weighted")
        if not error_samples:
            return parent
            
        # æ„å»ºåé¦ˆæç¤ºï¼ˆæ•™å­¦ä»»åŠ¡ï¼‰
        feedback_prompt = f"""åŸºäºä»¥ä¸‹æ•™å­¦æ•ˆæœä¸ä½³çš„æ ·æœ¬ï¼Œæ”¹è¿›æ•™å­¦æç¤ºè¯ï¼š

å½“å‰æç¤ºè¯ï¼š
{parent.prompt}

éœ€è¦æ”¹è¿›çš„æ ·æœ¬ï¼š
"""
        for i, sample in enumerate(error_samples, 1):
            feedback_prompt += f"""
æ ·æœ¬{i}:
- å­¦ç”Ÿä»£ç : {sample.get('input', '')[:100]}...
- åŠ©æ‰‹å›ç­”: {sample.get('output', '')[:100]}...
- å¾—åˆ†: {sample.get('score', 0):.2f}
- é—®é¢˜: {sample.get('reason', 'æ•™å­¦æ•ˆæœä¸ä½³')}
"""
            
        feedback_prompt += """
è¯·ç”Ÿæˆæ”¹è¿›åçš„æ•™å­¦æç¤ºè¯ï¼Œè¦æ±‚ï¼š
1. é’ˆå¯¹è¿™äº›é—®é¢˜ä¼˜åŒ–æ•™å­¦æ–¹æ³•
2. æé«˜é”™è¯¯è¯†åˆ«çš„å‡†ç¡®æ€§
3. å¢å¼ºæ•™è‚²å¼•å¯¼æ€§ï¼ˆå¼•å¯¼å­¦ç”Ÿæ€è€ƒï¼Œä¸ç›´æ¥ç»™ç­”æ¡ˆï¼‰
4. æ”¹è¿›è§£é‡Šçš„æ¸…æ™°åº¦
5. ä¿æŒé€‚åˆPythonè¯­æ³•é”™è¯¯æ•™å­¦çš„é£æ ¼
6. è¾“å‡ºæ ¼å¼è¦æ±‚ï¼šä»£ç ç‰‡æ®µã€é”™è¯¯è§£é‡Šã€ä¿®æ­£å»ºè®®

è¯·ç”Ÿæˆæ”¹è¿›åçš„æç¤ºè¯ï¼š"""

        try:
            response = self.llm_interface.invoke([
                {"role": "user", "content": feedback_prompt}
            ], thinking_mode="disabled", timeout=60)
            
            if response and response.strip():
                return PromptCandidate(prompt=response.strip())
                
        except Exception as e:
            print(f"åé¦ˆå˜å¼‚å¤±è´¥: {e}")
            
        return parent
    
    def lamarckian_mutation(self, parent):
        """Lamarckianå˜å¼‚ - è½»å¾®æ”¹è¿›ï¼ˆæ•™å­¦ä»»åŠ¡ä¸“ç”¨ï¼‰"""
        instruction = f"""åœ¨ä»¥ä¸‹æ•™å­¦æç¤ºè¯åŸºç¡€ä¸Šåšè½»å¾®æ”¹è¿›ï¼š

å½“å‰æç¤ºè¯ï¼š
{parent.prompt}

æ”¹è¿›è¦æ±‚ï¼š
1. ä¿ç•™æ ¸å¿ƒæ•™å­¦ç†å¿µå’Œç»“æ„
2. ä¼˜åŒ–é”™è¯¯è¯†åˆ«å’Œè§£é‡Šçš„æ–¹å¼
3. å¢å¼ºæ•™è‚²å¼•å¯¼æ€§ï¼ˆæé—®å¼•å¯¼è€Œéç›´æ¥ç»™ç­”æ¡ˆï¼‰
4. æ”¹è¿›è¾“å‡ºæ ¼å¼çš„æ¸…æ™°åº¦
5. é€‚å½“è°ƒæ•´è¯­è¨€è¡¨è¾¾ï¼Œä½¿å…¶æ›´ä¸“ä¸šæˆ–æ›´æ˜“æ‡‚
6. é’ˆå¯¹Pythonè¯­æ³•é”™è¯¯ï¼ˆç¼©è¿›ã€å†’å·ç­‰ï¼‰ä¼˜åŒ–è¯´æ˜
7. ä¸åŸæç¤ºè¯ä¿æŒ30%ä»¥ä¸Šçš„å·®å¼‚

è¯·ç”Ÿæˆæ”¹è¿›åçš„æç¤ºè¯ï¼š"""
        
        try:
            response = self.llm_interface.invoke([
                {"role": "user", "content": instruction}
            ], thinking_mode="disabled", timeout=60)
            
            if response and response.strip():
                return PromptCandidate(prompt=response.strip())
                
        except Exception as e:
            print(f"Lamarckianå˜å¼‚å¤±è´¥: {e}")
            
        return parent
    
    def semantic_mutation(self, parent):
        """è¯­ä¹‰å˜å¼‚ - é‡æ–°è¡¨è¾¾ï¼ˆæ•™å­¦ä»»åŠ¡ä¸“ç”¨ï¼‰"""
        instruction = f"""ç”¨ä¸åŒçš„æ–¹å¼é‡æ–°è¡¨è¾¾ä»¥ä¸‹æ•™å­¦æç¤ºè¯ï¼Œä¿æŒæ ¸å¿ƒæ•™å­¦ç›®æ ‡ï¼š

åŸæç¤ºè¯ï¼š
{parent.prompt}

è¦æ±‚ï¼š
1. ç”¨ä¸åŒçš„è¯­è¨€é£æ ¼é‡æ–°è¡¨è¾¾ï¼ˆå¦‚ï¼šæ›´æ­£å¼/æ›´å‹å¥½/æ›´è¯¦ç»†/æ›´ç®€æ´ï¼‰
2. ä¿æŒæ ¸å¿ƒæ•™å­¦ç›®æ ‡ï¼šå¸®åŠ©å­¦ç”Ÿç†è§£Pythonè¯­æ³•é”™è¯¯
3. å¯ä»¥è°ƒæ•´ç»“æ„å’Œç»„ç»‡æ–¹å¼
4. ä¿æŒè¾“å‡ºæ ¼å¼è¦æ±‚
5. ç¡®ä¿æ•™è‚²å¼•å¯¼æ€§

è¯·ç”Ÿæˆé‡æ–°è¡¨è¾¾çš„æç¤ºè¯ï¼š"""
        
        try:
            response = self.llm_interface.invoke([
                {"role": "user", "content": instruction}
            ], thinking_mode="disabled", timeout=60)
            
            if response and response.strip():
                return PromptCandidate(prompt=response.strip())
                
        except Exception as e:
            print(f"è¯­ä¹‰å˜å¼‚å¤±è´¥: {e}")
            
        return parent
    
    def reflection_mutation(self, parent, generation=0):
        """Reflectionå˜å¼‚ - æ·±åº¦åˆ†ææ”¹è¿›ï¼ˆæ•™å­¦ä»»åŠ¡ä¸“ç”¨ï¼‰"""
        # è·å–ä½åˆ†æ ·æœ¬
        if not hasattr(self, 'fp_pool') or not self.fp_pool.samples:
            return parent
            
        error_samples = self.fp_pool.sample(k=5, strategy="weighted")
        if not error_samples:
            return parent
        
        # æ ¼å¼åŒ–é”™è¯¯æ ·æœ¬
        error_string = ""
        for i, sample in enumerate(error_samples, 1):
            error_string += f"""
æ ·æœ¬{i}:
- ä»£ç : {sample.get('input', '')[:80]}...
- å›ç­”: {sample.get('output', '')[:80]}...
- å¾—åˆ†: {sample.get('score', 0):.2f}
- é—®é¢˜: {sample.get('reason', 'æ•™å­¦æ•ˆæœä¸ä½³')}
"""
        
        # ç¬¬ä¸€é˜¶æ®µï¼šåˆ†ææç¤ºè¯çš„é—®é¢˜
        analysis_prompt = f"""ä½ æ˜¯ä¸€ä½ç¼–ç¨‹æ•™å­¦ä¸“å®¶ï¼Œè¯·åˆ†æä»¥ä¸‹æ•™å­¦æç¤ºè¯å­˜åœ¨çš„é—®é¢˜ï¼š

ã€å½“å‰æç¤ºè¯ã€‘
{parent.prompt}

ã€æ•™å­¦æ•ˆæœä¸ä½³çš„æ ·æœ¬ã€‘
{error_string}

è¯·æ·±å…¥åˆ†æï¼š
1. **æ•™å­¦æ–¹æ³•é—®é¢˜**ï¼š
   - é”™è¯¯è¯†åˆ«æ˜¯å¦å‡†ç¡®ï¼Ÿ
   - è§£é‡Šæ˜¯å¦æ¸…æ™°æ˜“æ‡‚ï¼Ÿ
   - æ˜¯å¦æœ‰æ•ˆå¼•å¯¼å­¦ç”Ÿæ€è€ƒï¼Ÿ

2. **æç¤ºè¯ç»“æ„é—®é¢˜**ï¼š
   - é€»è¾‘æ˜¯å¦æ¸…æ™°ï¼Ÿ
   - æ˜¯å¦æœ‰æ­§ä¹‰è¡¨è¾¾ï¼Ÿ
   - ç¼ºå°‘å“ªäº›å…³é”®æŒ‡å¯¼ï¼Ÿ

3. **é’ˆå¯¹Pythonè¯­æ³•é”™è¯¯çš„ä¸“ä¸šæ€§**ï¼š
   - å¯¹ç¼©è¿›ã€å†’å·ç­‰è¯­æ³•é”™è¯¯çš„å¤„ç†æ˜¯å¦ä¸“ä¸šï¼Ÿ
   - æ˜¯å¦é€‚åˆä¸åŒéš¾åº¦ç­‰çº§ï¼Ÿ

4. **æ”¹è¿›æ–¹å‘**ï¼š
   - å…·ä½“åº”è¯¥å¦‚ä½•æ”¹è¿›ï¼Ÿ
   - å“ªäº›éƒ¨åˆ†éœ€è¦åŠ å¼ºï¼Ÿ

è¯·ä»¥ç®€æ´çš„æ–‡å­—æ€»ç»“åˆ†æç»“æœï¼ˆä¸è¦JSONæ ¼å¼ï¼‰ï¼š"""

        try:
            analysis = self.llm_interface.invoke([
                {"role": "user", "content": analysis_prompt}
            ], thinking_mode="disabled", timeout=60)
            
            if not analysis or not analysis.strip():
                return parent
            
            # ç¬¬äºŒé˜¶æ®µï¼šåŸºäºåˆ†ææ”¹è¿›æç¤ºè¯
            mutation_prompt = f"""åŸºäºä¸“å®¶åˆ†æï¼Œæ”¹è¿›ä»¥ä¸‹æ•™å­¦æç¤ºè¯ï¼š

ã€å½“å‰æç¤ºè¯ã€‘
{parent.prompt}

ã€ä¸“å®¶åˆ†æã€‘
{analysis}

ã€æ”¹è¿›è¦æ±‚ã€‘
1. é’ˆå¯¹åˆ†æä¸­çš„é—®é¢˜è¿›è¡Œæ”¹è¿›
2. æé«˜é”™è¯¯è¯†åˆ«çš„å‡†ç¡®æ€§
3. å¢å¼ºæ•™è‚²å¼•å¯¼æ€§
4. æ”¹è¿›è§£é‡Šçš„æ¸…æ™°åº¦
5. ä¿æŒé€‚åˆPythonè¯­æ³•é”™è¯¯æ•™å­¦
6. è¾“å‡ºæ ¼å¼ï¼šä»£ç ç‰‡æ®µã€é”™è¯¯è§£é‡Šã€ä¿®æ­£å»ºè®®

è¯·ç”Ÿæˆæ”¹è¿›åçš„æç¤ºè¯ï¼š"""

            response = self.llm_interface.invoke([
                {"role": "user", "content": mutation_prompt}
            ], thinking_mode="disabled", timeout=60)
            
            if response and response.strip():
                return PromptCandidate(prompt=response.strip())
                
        except Exception as e:
            print(f"Reflectionå˜å¼‚å¤±è´¥: {e}")
            
        return parent
    
    def _load_generated_seeds(self) -> list:
        """
        åŠ è½½å¤§æ¨¡å‹ç”Ÿæˆçš„ç§å­æç¤ºè¯
        """
        import json
        import os
        
        seed_file = os.path.join(
            os.path.dirname(__file__), 
            'generated_seed_prompts.json'
        )
        
        if not os.path.exists(seed_file):
            return []
        
        try:
            with open(seed_file, 'r', encoding='utf-8') as f:
                data = json.load(f)
                prompts = data.get('prompts', [])
                return prompts
        except Exception as e:
            print(f"[WARN] åŠ è½½ç”Ÿæˆçš„ç§å­å¤±è´¥: {e}")
            return []
    
    def create_initial_population(self, size: int, target_tag: str) -> list:
        """
        åˆ›å»ºåˆå§‹ç§ç¾¤ - ä½¿ç”¨ç¼–ç¨‹æ•™å­¦ç›¸å…³çš„ç§å­æç¤ºè¯
        ä¼˜å…ˆåŠ è½½å¤§æ¨¡å‹ç”Ÿæˆçš„ç§å­ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤ç§å­
        """
        print(f"[INIT] åˆ›å»ºç¼–ç¨‹æ•™å­¦åˆå§‹ç§ç¾¤: å¤§å°={size}")
        initial_population = []
        
        # å°è¯•åŠ è½½å¤§æ¨¡å‹ç”Ÿæˆçš„ç§å­æç¤ºè¯
        generated_prompts = self._load_generated_seeds()
        if generated_prompts and len(generated_prompts) >= size:
            print(f"[INIT] âœ… ä½¿ç”¨å¤§æ¨¡å‹ç”Ÿæˆçš„ç§å­æç¤ºè¯ ({len(generated_prompts)} ä¸ª)")
            seed_templates = generated_prompts
        else:
            print(f"[INIT] â„¹ï¸  ä½¿ç”¨é»˜è®¤ç§å­æç¤ºè¯")
            # å®šä¹‰ç¼–ç¨‹æ•™å­¦çš„ç§å­æç¤ºè¯æ¨¡æ¿ï¼ˆè‡ªç„¶è¯­è¨€æ•™å­¦é£æ ¼ï¼‰
            seed_templates = [
                # æ¨¡æ¿1: å‹å¥½å¼•å¯¼å‹
                """ä½ æ˜¯ä¸€ä½è€å¿ƒçš„Pythonç¼–ç¨‹æ•™å­¦åŠ©æ‰‹ï¼Œå¸®åŠ©å­¦ç”Ÿç†è§£å’Œä¿®æ­£ä»£ç é”™è¯¯ã€‚

å½“å­¦ç”Ÿæäº¤æœ‰é—®é¢˜çš„ä»£ç æ—¶ï¼Œä½ ä¼šï¼š

1. **è¯†åˆ«é”™è¯¯**ï¼šå‡†ç¡®æ‰¾å‡ºä»£ç ä¸­çš„é—®é¢˜ï¼ˆè¯­æ³•é”™è¯¯ã€è¿è¡Œæ—¶é”™è¯¯ã€é€»è¾‘é”™è¯¯ï¼‰
2. **è§£é‡ŠåŸå› **ï¼šç”¨ç®€å•æ˜“æ‡‚çš„è¯­è¨€è¯´æ˜ä¸ºä»€ä¹ˆä¼šå‡ºé”™
3. **å¼•å¯¼æ€è€ƒ**ï¼šé€šè¿‡æé—®å¼•å¯¼å­¦ç”Ÿè‡ªå·±å‘ç°é—®é¢˜ï¼Œè€Œä¸æ˜¯ç›´æ¥ç»™ç­”æ¡ˆ
4. **æä¾›å»ºè®®**ï¼šç»™å‡ºä¿®æ­£çš„æ–¹å‘å’Œå­¦ä¹ å»ºè®®

ä½ çš„å›ç­”åº”è¯¥åŒ…å«ï¼š
- æŒ‡å‡ºé”™è¯¯çš„å…·ä½“ä½ç½®
- è§£é‡Šé”™è¯¯çš„åŸå› 
- æä¾›ä¿®æ­£çš„æ€è·¯ï¼ˆä¸ç›´æ¥ç»™å®Œæ•´ä»£ç ï¼‰
- ç›¸å…³çš„PythonçŸ¥è¯†ç‚¹

è®°ä½ï¼šä½ çš„ç›®æ ‡æ˜¯å¸®åŠ©å­¦ç”Ÿå­¦ä¼šç‹¬ç«‹æ€è€ƒå’Œè§£å†³é—®é¢˜ã€‚""",

            # æ¨¡æ¿2: ç»“æ„åŒ–æ•™å­¦å‹
            """Pythonç¼–ç¨‹æ•™å­¦åŠ©æ‰‹

æˆ‘ä¼šå¸®åŠ©ä½ ç†è§£å’Œä¿®æ­£Pythonä»£ç ä¸­çš„å„ç±»é”™è¯¯ï¼š
- è¯­æ³•é”™è¯¯ï¼ˆç¼©è¿›ã€å†’å·ã€æ‹¬å·ç­‰ï¼‰
- è¿è¡Œæ—¶é”™è¯¯ï¼ˆé™¤é›¶ã€ç±»å‹é”™è¯¯ã€é”®é”™è¯¯ç­‰ï¼‰
- é€»è¾‘é”™è¯¯ï¼ˆä½œç”¨åŸŸã€æ‹·è´ã€è¿­ä»£ç­‰ï¼‰

é’ˆå¯¹æ¯ä¸ªé”™è¯¯ï¼Œæˆ‘ä¼šï¼š

**ç¬¬ä¸€æ­¥ï¼šå®šä½é—®é¢˜**
æ˜ç¡®æŒ‡å‡ºå“ªä¸€è¡Œã€å“ªä¸ªä½ç½®æœ‰é—®é¢˜

**ç¬¬äºŒæ­¥ï¼šè§£é‡ŠåŸå› **
è¯´æ˜ä¸ºä»€ä¹ˆPythonä¼šæŠ¥è¿™ä¸ªé”™è¯¯ï¼ŒèƒŒåçš„åŸç†æ˜¯ä»€ä¹ˆ

**ç¬¬ä¸‰æ­¥ï¼šå¼•å¯¼ä¿®æ­£**
æä¾›ä¿®æ­£çš„æ–¹å‘å’Œå»ºè®®ï¼Œé¼“åŠ±ä½ è‡ªå·±å°è¯•ä¿®æ”¹

**ç¬¬å››æ­¥ï¼šçŸ¥è¯†æ‹“å±•**
è¡¥å……ç›¸å…³çš„Pythonæ¦‚å¿µå’Œæœ€ä½³å®è·µ

æˆ‘ä¼šæ ¹æ®é”™è¯¯çš„éš¾åº¦è°ƒæ•´è§£é‡Šçš„æ·±åº¦ï¼Œç¡®ä¿ä½ èƒ½ç†è§£ã€‚""",

            # æ¨¡æ¿3: å®è·µå¯¼å‘å‹
            """ä½œä¸ºPythonæ•™å­¦åŠ©æ‰‹ï¼Œæˆ‘ä¸“æ³¨äºå¸®åŠ©å­¦ç”Ÿé€šè¿‡å®è·µå­¦ä¹ ã€‚

é‡åˆ°ä»£ç é”™è¯¯æ—¶ï¼Œæˆ‘ä¼šè¿™æ ·å¸®åŠ©ä½ ï¼š

ğŸ“ **é”™è¯¯å®šä½**
- æŒ‡å‡ºå…·ä½“çš„é”™è¯¯è¡Œå’Œä»£ç ç‰‡æ®µ
- è¯´æ˜è¿™æ˜¯ä»€ä¹ˆç±»å‹çš„é”™è¯¯

ğŸ’¡ **åŸå› åˆ†æ**
- è§£é‡Šä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé”™è¯¯
- è¯´æ˜é”™è¯¯ä¼šå¯¼è‡´ä»€ä¹ˆåæœ

ğŸ”§ **ä¿®æ­£æŒ‡å¯¼**
- æä¾›ä¿®æ­£çš„æ€è·¯å’Œæ–¹å‘
- ç»™å‡ºç›¸å…³çš„ä»£ç ç¤ºä¾‹ï¼ˆä¸ç›´æ¥ç»™å®Œæ•´ç­”æ¡ˆï¼‰
- å»ºè®®ä½ å¯ä»¥å°è¯•çš„ä¿®æ”¹æ–¹æ³•

ğŸ“š **å­¦ä¹ å»ºè®®**
- è¡¥å……ç›¸å…³çš„PythonçŸ¥è¯†ç‚¹
- æä¾›é¿å…ç±»ä¼¼é”™è¯¯çš„æŠ€å·§

æˆ‘çš„æ•™å­¦é£æ ¼æ˜¯å¼•å¯¼å¼çš„ï¼Œå¸®åŠ©ä½ åŸ¹å…»ç‹¬ç«‹è§£å†³é—®é¢˜çš„èƒ½åŠ›ã€‚""",

            # æ¨¡æ¿4: ç®€æ´æ¸…æ™°å‹
            """Pythonä»£ç è¯Šæ–­åŠ©æ‰‹

æˆ‘å¸®åŠ©å­¦ç”Ÿè¯†åˆ«å’Œç†è§£Pythonä»£ç é”™è¯¯ã€‚

å¯¹äºæ¯ä¸ªé—®é¢˜ï¼Œæˆ‘ä¼šï¼š
1. æŒ‡å‡ºé”™è¯¯ä½ç½®å’Œç±»å‹
2. è§£é‡Šé”™è¯¯åŸå› 
3. æä¾›ä¿®æ­£å»ºè®®
4. è¡¥å……ç›¸å…³çŸ¥è¯†

æ”¯æŒçš„é”™è¯¯ç±»å‹ï¼š
- è¯­æ³•é”™è¯¯ï¼šç¼©è¿›ã€å†’å·ã€æ‹¬å·ã€å¼•å·
- è¿è¡Œæ—¶é”™è¯¯ï¼šé™¤é›¶ã€ç±»å‹ã€é”®å€¼ã€ç´¢å¼•
- é€»è¾‘é”™è¯¯ï¼šä½œç”¨åŸŸã€æ‹·è´ã€è¿­ä»£ã€é»˜è®¤å‚æ•°

æ•™å­¦åŸåˆ™ï¼š
âœ“ æ¸…æ™°å‡†ç¡®çš„é”™è¯¯è¯†åˆ«
âœ“ é€šä¿—æ˜“æ‡‚çš„åŸå› è§£é‡Š
âœ“ å¼•å¯¼æ€è€ƒè€Œéç›´æ¥ç»™ç­”æ¡ˆ
âœ“ é€‚åˆä¸åŒæ°´å¹³çš„å­¦ç”Ÿ""",

            # æ¨¡æ¿5: å¯¹è¯å¼æ•™å­¦å‹
            """å—¨ï¼æˆ‘æ˜¯ä½ çš„Pythonå­¦ä¹ ä¼™ä¼´ï¼Œä¸“é—¨å¸®åŠ©ä½ ç†è§£ä»£ç ä¸­çš„é”™è¯¯ã€‚

å½“ä½ çš„ä»£ç å‡ºç°é—®é¢˜æ—¶ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¥åˆ†æï¼š

**ğŸ” é¦–å…ˆï¼Œæˆ‘ä¼šå¸®ä½ æ‰¾å‡ºé—®é¢˜åœ¨å“ªé‡Œ**
æˆ‘ä¼šä»”ç»†æ£€æŸ¥ä½ çš„ä»£ç ï¼Œå‘Šè¯‰ä½ å…·ä½“å“ªä¸€è¡Œã€å“ªä¸ªåœ°æ–¹æœ‰é—®é¢˜ï¼Œæ˜¯ä»€ä¹ˆç±»å‹çš„é”™è¯¯ã€‚

**ğŸ¤” ç„¶åï¼Œæˆ‘ä»¬ä¸€èµ·ç†è§£ä¸ºä»€ä¹ˆä¼šå‡ºé”™**
æˆ‘ä¼šç”¨ç®€å•çš„è¯­è¨€è§£é‡Šé”™è¯¯çš„åŸå› ï¼Œå¸®åŠ©ä½ ç†è§£Pythonçš„å·¥ä½œåŸç†ã€‚

**ğŸ’ª æ¥ç€ï¼Œæˆ‘ä¼šå¼•å¯¼ä½ è‡ªå·±ä¿®æ­£**
æˆ‘ä¸ä¼šç›´æ¥ç»™ä½ ç­”æ¡ˆï¼Œè€Œæ˜¯æä¾›æ€è·¯å’Œæ–¹å‘ï¼Œé¼“åŠ±ä½ è‡ªå·±å°è¯•ä¿®æ”¹ã€‚è¿™æ ·ä½ æ‰èƒ½çœŸæ­£å­¦ä¼šã€‚

**ğŸ“– æœ€åï¼Œæˆ‘ä¼šè¡¥å……ç›¸å…³çŸ¥è¯†**
æˆ‘ä¼šåˆ†äº«ä¸€äº›Pythonçš„æœ€ä½³å®è·µå’Œå°æŠ€å·§ï¼Œå¸®åŠ©ä½ é¿å…ç±»ä¼¼çš„é”™è¯¯ã€‚

æ— è®ºæ˜¯è¯­æ³•é”™è¯¯ã€è¿è¡Œæ—¶é”™è¯¯è¿˜æ˜¯é€»è¾‘é”™è¯¯ï¼Œæˆ‘éƒ½ä¼šè€å¿ƒåœ°å¸®åŠ©ä½ ç†è§£å’Œè§£å†³ï¼""",

            # æ¨¡æ¿6: åˆ†å±‚æ•™å­¦å‹
            """Pythonç¼–ç¨‹é”™è¯¯è¯Šæ–­ä¸æ•™å­¦åŠ©æ‰‹

æˆ‘æ ¹æ®é”™è¯¯çš„éš¾åº¦å’Œç±»å‹ï¼Œæä¾›åˆ†å±‚æ¬¡çš„æ•™å­¦æŒ‡å¯¼ï¼š

ã€åˆçº§é”™è¯¯ã€‘ï¼ˆè¯­æ³•åŸºç¡€ï¼‰
- ç¼©è¿›é”™è¯¯ã€å†’å·é—æ¼ã€æ‹¬å·ä¸åŒ¹é…
- è¯¦ç»†è§£é‡ŠPythonè¯­æ³•è§„åˆ™
- æä¾›ç›´è§‚çš„ä¿®æ­£ç¤ºä¾‹

ã€ä¸­çº§é”™è¯¯ã€‘ï¼ˆè¿è¡Œæ—¶é—®é¢˜ï¼‰
- ç±»å‹é”™è¯¯ã€é™¤é›¶é”™è¯¯ã€é”®å€¼é”™è¯¯
- è§£é‡ŠPythonçš„ç±»å‹ç³»ç»Ÿå’Œå¼‚å¸¸æœºåˆ¶
- å¼•å¯¼å­¦ç”Ÿæ€è€ƒå¦‚ä½•é¢„é˜²

ã€é«˜çº§é”™è¯¯ã€‘ï¼ˆé€»è¾‘é™·é˜±ï¼‰
- ä½œç”¨åŸŸé—®é¢˜ã€æµ…æ·±æ‹·è´ã€å¯å˜é»˜è®¤å‚æ•°
- æ·±å…¥è®²è§£Pythonçš„å†…å­˜æ¨¡å‹å’Œæ‰§è¡Œæœºåˆ¶
- åŸ¹å…»è‰¯å¥½çš„ç¼–ç¨‹ä¹ æƒ¯

æˆ‘çš„æ•™å­¦æ–¹æ³•ï¼š
1. å‡†ç¡®è¯†åˆ«é”™è¯¯ç±»å‹å’Œä½ç½®
2. æ ¹æ®éš¾åº¦è°ƒæ•´è§£é‡Šæ·±åº¦
3. æä¾›æ¸…æ™°çš„ä¿®æ­£æ€è·¯
4. å¼•å¯¼å­¦ç”Ÿç‹¬ç«‹æ€è€ƒ
5. è¡¥å……ç›¸å…³çš„Pythonæ¦‚å¿µ

è¾“å‡ºé£æ ¼ï¼šè‡ªç„¶è¯­è¨€ï¼Œæ¸…æ™°æ˜“æ‡‚ï¼Œå¾ªåºæ¸è¿›ã€‚""",
            ]
        
        # æ·»åŠ ç§å­æç¤ºè¯åˆ°ç§ç¾¤
        for i, template in enumerate(seed_templates[:size]):
            candidate = PromptCandidate(prompt=template)
            initial_population.append(candidate)
            print(f"[INIT] ç§å­æç¤ºè¯ {i+1}: {template[:80]}...")
        
        # å¦‚æœç§å­ä¸å¤Ÿï¼Œä½¿ç”¨LLMç”Ÿæˆæ›´å¤šå˜ä½“
        remaining = size - len(initial_population)
        if remaining > 0:
            print(f"[INIT] ä½¿ç”¨LLMç”Ÿæˆ {remaining} ä¸ªå˜ä½“...")
            for i in range(remaining):
                try:
                    generation_prompt = f"""è¯·ä¸ºç¼–ç¨‹æ•™å­¦åœºæ™¯ç”Ÿæˆä¸€ä¸ªç³»ç»Ÿæç¤ºè¯ã€‚

ä»»åŠ¡ï¼šå¸®åŠ©å­¦ç”Ÿåˆ†æä»£ç é”™è¯¯ï¼ŒåŒ…æ‹¬è¯­æ³•é”™è¯¯ã€é€»è¾‘é”™è¯¯å’Œæ¦‚å¿µé”™è¯¯ã€‚

è¦æ±‚ï¼š
1. æç¤ºè¯è¦æ¸…æ™°æ˜ç¡®
2. å¼ºè°ƒæ•™è‚²å¼•å¯¼æ€§ï¼Œä¸ç›´æ¥ç»™ç­”æ¡ˆ
3. è¦æ±‚è¾“å‡ºåŒ…å«ï¼šä»£ç ç‰‡æ®µã€é”™è¯¯è§£é‡Šã€ä¿®æ­£å»ºè®®
4. è¯­è¨€ç®€æ´ä¸“ä¸š
5. é€‚åˆä¸­æ–‡ç¼–ç¨‹æ•™å­¦åœºæ™¯

è¯·ç”Ÿæˆä¸€ä¸ªé«˜è´¨é‡çš„æ•™å­¦æç¤ºè¯ï¼š"""
                    
                    response = self.llm_interface.invoke([
                        {"role": "user", "content": generation_prompt}
                    ], thinking_mode="disabled", timeout=60)
                    
                    if response and response.strip():
                        prompt = response.strip()
                        candidate = PromptCandidate(prompt=prompt)
                        initial_population.append(candidate)
                        print(f"[INIT] LLMç”Ÿæˆ {i+1}: {prompt[:80]}...")
                    else:
                        # å¦‚æœç”Ÿæˆå¤±è´¥ï¼Œå¤ç”¨ç§å­æ¨¡æ¿
                        fallback_template = seed_templates[i % len(seed_templates)]
                        candidate = PromptCandidate(prompt=fallback_template)
                        initial_population.append(candidate)
                        print(f"[INIT] ä½¿ç”¨å¤‡ç”¨æ¨¡æ¿ {i+1}")
                        
                except Exception as e:
                    print(f"[INIT] ç”Ÿæˆå¤±è´¥ {i+1}: {e}")
                    # ä½¿ç”¨å¤‡ç”¨æ¨¡æ¿
                    fallback_template = seed_templates[i % len(seed_templates)]
                    candidate = PromptCandidate(prompt=fallback_template)
                    initial_population.append(candidate)
        
        print(f"[INIT] åˆå§‹ç§ç¾¤åˆ›å»ºå®Œæˆ: {len(initial_population)} ä¸ªå€™é€‰")
        return initial_population


if __name__ == "__main__":
    # æµ‹è¯•
    print("æµ‹è¯•æ•™å­¦ä¼˜åŒ–å™¨åŒ…è£…å™¨...")
    
    config = {
        'population_size': 4,
        'total_generations': 2,
        'max_tokens': 10000
    }
    
    optimizer = TeachingOptimizer(config)
    population = optimizer.create_initial_population(4, "ç¼–ç¨‹æ•™å­¦é”™è¯¯æ£€æµ‹")
    
    print(f"\nç”Ÿæˆäº† {len(population)} ä¸ªåˆå§‹å€™é€‰")
    for i, candidate in enumerate(population):
        print(f"\nå€™é€‰ {i+1}:")
        print(f"  é•¿åº¦: {len(candidate.prompt)} å­—ç¬¦")
        print(f"  é¢„è§ˆ: {candidate.prompt[:150]}...")

